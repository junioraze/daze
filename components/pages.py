"""
P√°ginas espec√≠ficas para demonstrar funcionalidades do DAZE
"""
from h2o_wave import ui, Q
from .base import BaseCard
from .charts import ChartComponent
from .stats import StatsComponent  
from .tables import TableComponent
from services.data_service import DataService


class DashboardPage(BaseCard):
    """P√°gina principal - Dashboard geral"""
    
    def __init__(self, card_id: str = "dashboard_page"):
        super().__init__(card_id)
        self.stats = StatsComponent('dashboard_stats')
        self.chart = ChartComponent('dashboard_chart')
        self.data_service = DataService()
    
    async def create(self, q: Q, **kwargs) -> None:
        """Cria a p√°gina de dashboard"""
        try:
            # Dados resumidos
            sales_data = await self.data_service.get_sample_sales_data(days=30)
            product_data = await self.data_service.get_sample_product_data(count=10)
            
            # Estat√≠sticas gerais
            total_sales = sum([item['value'] for item in sales_data])
            avg_daily = total_sales / 30
            total_products = len(product_data)
            
            # Stats card
            await self.stats.create(q,
                title="üìä Resumo Geral - 30 dias",
                metrics=[
                    {'label': 'Vendas Total', 'value': f'${total_sales:,.2f}', 'delta': '+12.5%'},
                    {'label': 'M√©dia Di√°ria', 'value': f'${avg_daily:,.2f}', 'delta': '+8.3%'},
                    {'label': 'Produtos Ativos', 'value': str(total_products), 'delta': '+2'},
                    {'label': 'Convers√£o', 'value': '3.4%', 'delta': '+0.8%'}
                ]
            )
            
            # Chart card
            await self.chart.create(q,
                title="üìà Vendas dos √öltimos 30 Dias",
                chart_data=sales_data,
                chart_type='line'
            )
            
            # Quick actions
            q.page[f'{self.card_id}_actions'] = ui.form_card(
                box='actions',
                title='üöÄ A√ß√µes R√°pidas',
                items=[
                    ui.text('**Navegue para p√°ginas espec√≠ficas:**'),
                    ui.buttons([
                        ui.button('nav_sales', 'üí∞ Analisar Vendas', primary=True),
                        ui.button('nav_products', 'üì¶ Filtrar Produtos'),
                    ]),
                    ui.buttons([
                        ui.button('nav_reports', 'üìã Gerar Relat√≥rios'),
                        ui.button('nav_analytics', 'üìà Analytics Avan√ßado')
                    ]),
                ]
            )
            
        except Exception as e:
            await self._handle_error(q, f"Erro no Dashboard: {str(e)}")


class SalesPage(BaseCard):
    """P√°gina de an√°lise de vendas"""
    
    def __init__(self, card_id: str = "sales_page"):
        super().__init__(card_id)
        self.chart = ChartComponent('sales_chart')
        self.stats = StatsComponent('sales_stats')
        self.data_service = DataService()
    
    async def create(self, q: Q, **kwargs) -> None:
        """Cria a p√°gina de vendas"""
        days = kwargs.get('days', 7)
        
        try:
            # Controles de filtro
            q.page[f'{self.card_id}_controls'] = ui.form_card(
                box='controls',
                title='üéõÔ∏è Filtros de Vendas',
                items=[
                    ui.text('**Configure o per√≠odo de an√°lise:**'),
                    ui.spinbox('sales_days', label='Per√≠odo (dias)', value=days, min=1, max=90),
                    ui.dropdown('sales_metric', label='M√©trica', value='revenue', choices=[
                        ui.choice('revenue', 'Receita'),
                        ui.choice('quantity', 'Quantidade'),
                        ui.choice('profit', 'Lucro')
                    ]),
                    ui.button('apply_sales_filter', 'üîç Aplicar Filtros', primary=True)
                ]
            )
            
            # Dados de vendas
            sales_data = await self.data_service.get_sample_sales_data(days=days)
            
            # C√°lculos
            total_sales = sum([item['value'] for item in sales_data])
            avg_sale = total_sales / len(sales_data) if sales_data else 0
            
            # Stats
            await self.stats.create(q,
                title=f"üìä Vendas - {days} dias",
                metrics=[
                    {'label': 'Total', 'value': f'${total_sales:,.2f}', 'delta': '+15.2%'},
                    {'label': 'M√©dia', 'value': f'${avg_sale:,.2f}', 'delta': '+5.1%'},
                    {'label': 'Transa√ß√µes', 'value': str(len(sales_data)), 'delta': '+23'},
                    {'label': 'Ticket M√©dio', 'value': f'${avg_sale * 1.2:,.2f}', 'delta': '+7.8%'}
                ]
            )
            
            # Chart
            await self.chart.create(q,
                title=f"üìà Evolu√ß√£o de Vendas - {days} dias",
                chart_data=sales_data,
                chart_type='area'
            )
            
        except Exception as e:
            await self._handle_error(q, f"Erro na p√°gina de Vendas: {str(e)}")


class ProductsPage(BaseCard):
    """P√°gina de gest√£o de produtos"""
    
    def __init__(self, card_id: str = "products_page"):
        super().__init__(card_id)
        self.table = TableComponent('products_table')
        self.stats = StatsComponent('products_stats')
        self.data_service = DataService()
    
    async def create(self, q: Q, **kwargs) -> None:
        """Cria a p√°gina de produtos"""
        category = kwargs.get('category', 'all')
        count = kwargs.get('count', 15)
        
        try:
            # Controles
            q.page[f'{self.card_id}_controls'] = ui.form_card(
                box='controls',
                title='üéõÔ∏è Filtros de Produtos',
                items=[
                    ui.text('**Filtrar produtos por categoria:**'),
                    ui.dropdown('product_category', label='Categoria', value=category, choices=[
                        ui.choice('all', 'Todas'),
                        ui.choice('electronics', 'Eletr√¥nicos'),
                        ui.choice('clothing', 'Roupas'),
                        ui.choice('home', 'Casa'),
                        ui.choice('sports', 'Esportes')
                    ]),
                    ui.spinbox('product_count', label='Quantidade', value=count, min=5, max=50),
                    ui.button('apply_product_filter', 'üîç Filtrar Produtos', primary=True)
                ]
            )
            
            # Dados
            product_data = await self.data_service.get_sample_product_data(count=count)
            
            # Stats
            total_value = sum([p.get('price', 0) for p in product_data])
            avg_price = total_value / len(product_data) if product_data else 0
            
            await self.stats.create(q,
                title=f"üì¶ Produtos - {category.title()}",
                metrics=[
                    {'label': 'Total Produtos', 'value': str(len(product_data)), 'delta': '+5'},
                    {'label': 'Valor Total', 'value': f'${total_value:,.2f}', 'delta': '+12%'},
                    {'label': 'Pre√ßo M√©dio', 'value': f'${avg_price:,.2f}', 'delta': '+3%'},
                    {'label': 'Categoria', 'value': category.title(), 'delta': ''}
                ]
            )
            
            # Tabela
            await self.table.create(q,
                title=f"üìã Lista de Produtos - {category.title()}",
                table_data=product_data,
                columns=['name', 'category', 'price', 'stock']
            )
            
        except Exception as e:
            await self._handle_error(q, f"Erro na p√°gina de Produtos: {str(e)}")


class ReportsPage(BaseCard):
    """P√°gina de relat√≥rios customizados"""
    
    def __init__(self, card_id: str = "reports_page"):
        super().__init__(card_id)
        self.table = TableComponent('reports_table')
        self.chart = ChartComponent('reports_chart')
        self.data_service = DataService()
    
    async def create(self, q: Q, **kwargs) -> None:
        """Cria a p√°gina de relat√≥rios"""
        report_type = kwargs.get('report_type', 'sales')
        user_count = kwargs.get('user_count', 10)
        
        try:
            # Controles
            q.page[f'{self.card_id}_controls'] = ui.form_card(
                box='controls',
                title='üìã Gerador de Relat√≥rios',
                items=[
                    ui.text('**Configure seu relat√≥rio personalizado:**'),
                    ui.dropdown('report_type', label='Tipo de Relat√≥rio', value=report_type, choices=[
                        ui.choice('sales', 'Relat√≥rio de Vendas'),
                        ui.choice('users', 'Relat√≥rio de Usu√°rios'),
                        ui.choice('products', 'Relat√≥rio de Produtos'),
                        ui.choice('performance', 'Relat√≥rio de Performance')
                    ]),
                    ui.spinbox('report_count', label='Registros', value=user_count, min=5, max=100),
                    ui.button('generate_custom_report', 'üìä Gerar Relat√≥rio', primary=True)
                ]
            )
            
            # Gera dados baseado no tipo
            if report_type == 'users':
                data = await self.data_service.get_sample_user_data(count=user_count)
                await self.table.create(q,
                    title=f"üë• Relat√≥rio de Usu√°rios ({user_count} registros)",
                    table_data=data,
                    columns=['name', 'email', 'role', 'last_login']
                )
            else:
                # Relat√≥rio de vendas padr√£o
                sales_data = await self.data_service.get_sample_sales_data(days=30)
                await self.chart.create(q,
                    title=f"üìà Relat√≥rio de {report_type.title()}",
                    chart_data=sales_data,
                    chart_type='column'
                )
            
        except Exception as e:
            await self._handle_error(q, f"Erro na p√°gina de Relat√≥rios: {str(e)}")


class AnalyticsPage(BaseCard):
    """P√°gina de analytics avan√ßado"""
    
    def __init__(self, card_id: str = "analytics_page"):
        super().__init__(card_id)
        self.chart1 = ChartComponent('analytics_chart1')
        self.chart2 = ChartComponent('analytics_chart2')
        self.stats = StatsComponent('analytics_stats')
        self.data_service = DataService()
    
    async def create(self, q: Q, **kwargs) -> None:
        """Cria a p√°gina de analytics"""
        try:
            # Controles
            q.page[f'{self.card_id}_controls'] = ui.form_card(
                box='controls',
                title='üìà Analytics Avan√ßado',
                items=[
                    ui.text('**An√°lises comparativas e tend√™ncias:**'),
                    ui.dropdown('analytics_period', label='Per√≠odo', value='month', choices=[
                        ui.choice('week', '√öltima Semana'),
                        ui.choice('month', '√öltimo M√™s'),
                        ui.choice('quarter', '√öltimo Trimestre'),
                        ui.choice('year', '√öltimo Ano')
                    ]),
                    ui.button('refresh_analytics', 'üîÑ Atualizar Analytics', primary=True)
                ]
            )
            
            # Dados para diferentes an√°lises
            sales_data = await self.data_service.get_sample_sales_data(days=30)
            product_data = await self.data_service.get_sample_product_data(count=20)
            
            # Stats avan√ßados
            await self.stats.create(q,
                title="üìä KPIs Avan√ßados",
                metrics=[
                    {'label': 'ROI', 'value': '24.5%', 'delta': '+3.2%'},
                    {'label': 'Churn Rate', 'value': '2.1%', 'delta': '-0.5%'},
                    {'label': 'LTV', 'value': '$1,250', 'delta': '+15%'},
                    {'label': 'CAC', 'value': '$45', 'delta': '-8%'}
                ]
            )
            
            # Charts comparativos
            await self.chart1.create(q,
                title="üìà Tend√™ncia de Crescimento",
                chart_data=sales_data,
                chart_type='area'
            )
            
            # Simula dados de produtos para pie chart
            product_chart_data = [
                {'category': 'Electronics', 'value': 45},
                {'category': 'Clothing', 'value': 30},
                {'category': 'Home', 'value': 15},
                {'category': 'Sports', 'value': 10}
            ]
            
            await self.chart2.create(q,
                title="ü•ß Distribui√ß√£o por Categoria",
                chart_data=product_chart_data,
                chart_type='pie'
            )
            
        except Exception as e:
            await self._handle_error(q, f"Erro na p√°gina de Analytics: {str(e)}")
